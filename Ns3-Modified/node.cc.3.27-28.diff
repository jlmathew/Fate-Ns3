--- ../../ns-3-dev/src/network/model/node.cc	2018-09-13 11:20:37.567447020 -0700
+++ node.cc	2018-09-13 16:14:56.702263394 -0700
@@ -18,7 +18,6 @@
  * Authors: George F. Riley<riley@ece.gatech.edu>
  *          Mathieu Lacage <mathieu.lacage@sophia.inria.fr>
  */
- 
 #include "node.h"
 #include "node-list.h"
 #include "net-device.h"
@@ -31,6 +30,8 @@
 #include "ns3/assert.h"
 #include "ns3/global-value.h"
 #include "ns3/boolean.h"
+#include "ns3/simulator.h"
+#include "ns3/fate-ipv4protocol.h"
 
 namespace ns3 {
 
@@ -77,7 +78,9 @@
 
 Node::Node()
   : m_id (0),
-    m_sid (0)
+    m_sid (0),
+    m_fateHandler(0),
+    m_fateExists(false)
 {
   NS_LOG_FUNCTION (this);
   Construct ();
@@ -85,7 +88,9 @@
 
 Node::Node(uint32_t sid)
   : m_id (0),
-    m_sid (sid)
+    m_sid (sid),
+    m_fateHandler(0),
+    m_fateExists(false)
 { 
   NS_LOG_FUNCTION (this << sid);
   Construct ();
@@ -222,6 +227,12 @@
 
   Object::DoInitialize ();
 }
+void
+Node::RegisterFateProtocolHandler (FateHandler handler)
+{
+    m_fateHandler= handler;
+    m_fateExists = true;
+}
 
 void
 Node::RegisterProtocolHandler (ProtocolHandler handler, 
@@ -304,12 +315,34 @@
   NS_LOG_FUNCTION (this << device << packet << protocol << &from << &to << packetType << promiscuous);
   NS_ASSERT_MSG (Simulator::GetContext () == GetId (), "Received packet with erroneous context ; " <<
                  "make sure the channels in use are correctly updating events context " <<
                  "when transfering events from one node to another.");
   NS_LOG_DEBUG ("Node " << GetId () << " ReceiveFromDevice:  dev "
                         << device->GetIfIndex () << " (type=" << device->GetInstanceTypeId ().GetName ()
                         << ") Packet UID " << packet->GetUid ());
   bool found = false;
 
+
+  //let fate have a chance
+  Ptr<Packet> packet2 = 0;// = packet->Copy();
+      if(m_fateExists) { 
+//std::cout << " Pre convert original pkt:";
+//packet->Print(std::cout);
+//std::cout << "\n";
+
+          uint32_t ms = packet->GetSerializedSize();
+          std::vector<uint8_t> pktvect(ms);
+          packet->Serialize((uint8_t *) &pktvect[0], ms);
+          
+          m_fateHandler (device, pktvect, protocol, from, to, packetType, promiscuous); //fateprotocol
+
+         packet2 = Create<Packet>((uint8_t *) &pktvect[0],pktvect.size(), true);
+//std::cout << " Post convert original pkt:";
+//packet2->Print(std::cout);
+//std::cout << "\n\n";
+
+      } else { packet2 = packet->Copy(); }
+
+
   for (ProtocolHandlerList::iterator i = m_handlers.begin ();
        i != m_handlers.end (); i++)
     {
@@ -321,7 +354,7 @@
             {
               if (promiscuous == i->promiscuous)
                 {
-                  i->handler (device, packet, protocol, from, to, packetType);
+                  i->handler (device, packet2, protocol, from, to, packetType);
                   found = true;
                 }
             }
@@ -369,3 +402,4 @@
  
 
 } // namespace ns3
+
